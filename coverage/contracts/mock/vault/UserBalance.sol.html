<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts/mock/vault/UserBalance.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../../prettify.css" />
    <link rel="stylesheet" href="../../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../../index.html">all files</a> / <a href="index.html">contracts/mock/vault/</a> UserBalance.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>0/55</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>0/16</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>0/11</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>0/55</span>
      </div>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">// SPDX-License-Identifier: GPL-3.0-or-later
// This program is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
&nbsp;
// This program is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU General Public License for more details.
&nbsp;
// You should have received a copy of the GNU General Public License
// along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
&nbsp;
pragma solidity ^0.7.0;
pragma experimental ABIEncoderV2;
&nbsp;
import "@balancer-labs/v2-solidity-utils/contracts/helpers/BalancerErrors.sol";
import "@balancer-labs/v2-solidity-utils/contracts/math/Math.sol";
import "@balancer-labs/v2-solidity-utils/contracts/openzeppelin/IERC20.sol";
import "@balancer-labs/v2-solidity-utils/contracts/openzeppelin/ReentrancyGuard.sol";
import "@balancer-labs/v2-solidity-utils/contracts/openzeppelin/SafeCast.sol";
import "@balancer-labs/v2-solidity-utils/contracts/openzeppelin/SafeERC20.sol";
&nbsp;
import "./AssetTransfersHandler.sol";
import "./VaultAuthorization.sol";
&nbsp;
/**
 * Implement User Balance interactions, which combine Internal Balance and using the Vault's ERC20 allowance.
 *
 * Users can deposit tokens into the Vault, where they are allocated to their Internal Balance, and later
 * transferred or withdrawn. It can also be used as a source of tokens when joining Pools, as a destination
 * when exiting them, and as either when performing swaps. This usage of Internal Balance results in greatly reduced
 * gas costs when compared to relying on plain ERC20 transfers, leading to large savings for frequent users.
 *
 * Internal Balance management features batching, which means a single contract call can be used to perform multiple
 * operations of different kinds, with different senders and recipients, at once.
 */
abstract contract UserBalance is ReentrancyGuard, AssetTransfersHandler, VaultAuthorization {
    using Math for uint256;
    using SafeCast for uint256;
    using SafeERC20 for IERC20;
&nbsp;
    // Internal Balance for each token, for each account.
    mapping(address =&gt; mapping(IERC20 =&gt; uint256)) private _internalTokenBalance;
&nbsp;
<span class="fstat-no" title="function not covered" >    function getInternalBalance(address user, IERC20[] memory tokens)</span>
        external
        view
        override
        returns (uint256[] memory balances)
    {
<span class="cstat-no" title="statement not covered" >        balances = new uint256[](tokens.length)</span>;
<span class="cstat-no" title="statement not covered" >        for (uint256 i = 0; i &lt; tokens.length; i++) {</span>
<span class="cstat-no" title="statement not covered" >            balances[i] = _getInternalBalance(user, tokens[i])</span>;
        }
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function manageUserBalance(UserBalanceOp[] memory ops) external payable override nonReentrant {</span>
        // We need to track how much of the received ETH was used and wrapped into WETH to return any excess.
<span class="cstat-no" title="statement not covered" >        uint256 ethWrapped = 0;</span>
&nbsp;
        // Cache for these checks so we only perform them once (if at all).
<span class="cstat-no" title="statement not covered" >        bool checkedCallerIsRelayer = false;</span>
<span class="cstat-no" title="statement not covered" >        bool checkedNotPaused = false;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >        for (uint256 i = 0; i &lt; ops.length; i++) {</span>
<span class="cstat-no" title="statement not covered" >            UserBalanceOpKind kind;</span>
<span class="cstat-no" title="statement not covered" >            IAsset asset;</span>
<span class="cstat-no" title="statement not covered" >            uint256 amount;</span>
<span class="cstat-no" title="statement not covered" >            address sender;</span>
<span class="cstat-no" title="statement not covered" >            address payable recipient;</span>
&nbsp;
            // This destructuring by calling `_validateUserBalanceOp` seems odd, but results in reduced bytecode size.
<span class="cstat-no" title="statement not covered" >            (kind, asset, amount, sender, recipient, checkedCallerIsRelayer) = _validateUserBalanceOp(</span>
                ops[i],
                checkedCallerIsRelayer
            );
&nbsp;
<span class="cstat-no" title="statement not covered" >            if (kind == UserBalanceOpKind.WITHDRAW_INTERNAL) {</span>
                // Internal Balance withdrawals can always be performed by an authorized account.
<span class="cstat-no" title="statement not covered" >                _withdrawFromInternalBalance(asset, sender, recipient, amount)</span>;
            } else {
                // All other operations are blocked if the contract is paused.
&nbsp;
                // We cache the result of the pause check and skip it for other operations in this same transaction
                // (if any).
<span class="cstat-no" title="statement not covered" >                if (!checkedNotPaused) {</span>
<span class="cstat-no" title="statement not covered" >                    _ensureNotPaused()</span>;
<span class="cstat-no" title="statement not covered" >                    checkedNotPaused = true</span>;
                }
&nbsp;
<span class="cstat-no" title="statement not covered" >                if (kind == UserBalanceOpKind.DEPOSIT_INTERNAL) {</span>
<span class="cstat-no" title="statement not covered" >                    _depositToInternalBalance(asset, sender, recipient, amount)</span>;
&nbsp;
                    // Keep track of all ETH wrapped into WETH as part of a deposit.
<span class="cstat-no" title="statement not covered" >                    if (_isETH(asset)) {</span>
<span class="cstat-no" title="statement not covered" >                        ethWrapped = ethWrapped.add(amount)</span>;
                    }
                } else {
                    // Transfers don't support ETH.
<span class="cstat-no" title="statement not covered" >                    _require(!_isETH(asset), Errors.CANNOT_USE_ETH_SENTINEL)</span>;
<span class="cstat-no" title="statement not covered" >                    IERC20 token = _asIERC20(asset);</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >                    if (kind == UserBalanceOpKind.TRANSFER_INTERNAL) {</span>
<span class="cstat-no" title="statement not covered" >                        _transferInternalBalance(token, sender, recipient, amount)</span>;
                    } else {
                        // TRANSFER_EXTERNAL
<span class="cstat-no" title="statement not covered" >                        _transferToExternalBalance(token, sender, recipient, amount)</span>;
                    }
                }
            }
        }
&nbsp;
        // Handle any remaining ETH.
<span class="cstat-no" title="statement not covered" >        _handleRemainingEth(ethWrapped)</span>;
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function _depositToInternalBalance(</span>
        IAsset asset,
        address sender,
        address recipient,
        uint256 amount
    ) private {
<span class="cstat-no" title="statement not covered" >        _increaseInternalBalance(recipient, _translateToIERC20(asset), amount)</span>;
<span class="cstat-no" title="statement not covered" >        _receiveAsset(asset, amount, sender, false)</span>;
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function _withdrawFromInternalBalance(</span>
        IAsset asset,
        address sender,
        address payable recipient,
        uint256 amount
    ) private {
        // A partial decrease of Internal Balance is disallowed: `sender` must have the full `amount`.
<span class="cstat-no" title="statement not covered" >        _decreaseInternalBalance(sender, _translateToIERC20(asset), amount, false)</span>;
<span class="cstat-no" title="statement not covered" >        _sendAsset(asset, amount, recipient, false)</span>;
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function _transferInternalBalance(</span>
        IERC20 token,
        address sender,
        address recipient,
        uint256 amount
    ) private {
        // A partial decrease of Internal Balance is disallowed: `sender` must have the full `amount`.
<span class="cstat-no" title="statement not covered" >        _decreaseInternalBalance(sender, token, amount, false)</span>;
<span class="cstat-no" title="statement not covered" >        _increaseInternalBalance(recipient, token, amount)</span>;
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function _transferToExternalBalance(</span>
        IERC20 token,
        address sender,
        address recipient,
        uint256 amount
    ) private {
<span class="cstat-no" title="statement not covered" >        if (amount &gt; 0) {</span>
<span class="cstat-no" title="statement not covered" >            token.safeTransferFrom(sender, recipient, amount)</span>;
<span class="cstat-no" title="statement not covered" >            emit ExternalBalanceTransfer(token, sender, recipient, amount);</span>
        }
    }
&nbsp;
    /**
     * @dev Increases `account`'s Internal Balance for `token` by `amount`.
     */
<span class="fstat-no" title="function not covered" >    function _increaseInternalBalance(</span>
        address account,
        IERC20 token,
        uint256 amount
    ) internal override {
<span class="cstat-no" title="statement not covered" >        uint256 currentBalance = _getInternalBalance(account, token);</span>
<span class="cstat-no" title="statement not covered" >        uint256 newBalance = currentBalance.add(amount);</span>
<span class="cstat-no" title="statement not covered" >        _setInternalBalance(account, token, newBalance, amount.toInt256())</span>;
    }
&nbsp;
    /**
     * @dev Decreases `account`'s Internal Balance for `token` by `amount`. If `allowPartial` is true, this function
     * doesn't revert if `account` doesn't have enough balance, and sets it to zero and returns the deducted amount
     * instead.
     */
<span class="fstat-no" title="function not covered" >    function _decreaseInternalBalance(</span>
        address account,
        IERC20 token,
        uint256 amount,
        bool allowPartial
    ) internal override returns (uint256 deducted) {
<span class="cstat-no" title="statement not covered" >        uint256 currentBalance = _getInternalBalance(account, token);</span>
<span class="cstat-no" title="statement not covered" >        _require(allowPartial || (currentBalance &gt;= amount), Errors.INSUFFICIENT_INTERNAL_BALANCE)</span>;
&nbsp;
<span class="cstat-no" title="statement not covered" >        deducted = Math.min(currentBalance, amount)</span>;
        // By construction, `deducted` is lower or equal to `currentBalance`, so we don't need to use checked
        // arithmetic.
<span class="cstat-no" title="statement not covered" >        uint256 newBalance = currentBalance - deducted;</span>
<span class="cstat-no" title="statement not covered" >        _setInternalBalance(account, token, newBalance, -(deducted.toInt256()))</span>;
    }
&nbsp;
    /**
     * @dev Sets `account`'s Internal Balance for `token` to `newBalance`.
     *
     * Emits an `InternalBalanceChanged` event. This event includes `delta`, which is the amount the balance increased
     * (if positive) or decreased (if negative). To avoid reading the current balance in order to compute the delta,
     * this function relies on the caller providing it directly.
     */
<span class="fstat-no" title="function not covered" >    function _setInternalBalance(</span>
        address account,
        IERC20 token,
        uint256 newBalance,
        int256 delta
    ) private {
<span class="cstat-no" title="statement not covered" >        _internalTokenBalance[account][token] = newBalance</span>;
<span class="cstat-no" title="statement not covered" >        emit InternalBalanceChanged(account, token, delta);</span>
    }
&nbsp;
    /**
     * @dev Returns `account`'s Internal Balance for `token`.
     */
<span class="fstat-no" title="function not covered" >    function _getInternalBalance(address account, IERC20 token) internal view returns (uint256) {</span>
<span class="cstat-no" title="statement not covered" >        return _internalTokenBalance[account][token];</span>
    }
&nbsp;
    /**
     * @dev Destructures a User Balance operation, validating that the contract caller is allowed to perform it.
     */
<span class="fstat-no" title="function not covered" >    function _validateUserBalanceOp(UserBalanceOp memory op, bool checkedCallerIsRelayer)</span>
        private
        view
        returns (
            UserBalanceOpKind,
            IAsset,
            uint256,
            address,
            address payable,
            bool
        )
    {
        // The only argument we need to validate is `sender`, which can only be either the contract caller, or a
        // relayer approved by `sender`.
<span class="cstat-no" title="statement not covered" >        address sender = op.sender;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >        if (sender != msg.sender) {</span>
            // We need to check both that the contract caller is a relayer, and that `sender` approved them.
&nbsp;
            // Because the relayer check is global (i.e. independent of `sender`), we cache that result and skip it for
            // other operations in this same transaction (if any).
<span class="cstat-no" title="statement not covered" >            if (!checkedCallerIsRelayer) {</span>
<span class="cstat-no" title="statement not covered" >                _authenticateCaller()</span>;
<span class="cstat-no" title="statement not covered" >                checkedCallerIsRelayer = true</span>;
            }
&nbsp;
<span class="cstat-no" title="statement not covered" >            _require(_hasApprovedRelayer(sender, msg.sender), Errors.USER_DOESNT_ALLOW_RELAYER)</span>;
        }
&nbsp;
<span class="cstat-no" title="statement not covered" >        return (op.kind, op.asset, op.amount, sender, op.recipient, checkedCallerIsRelayer);</span>
    }
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Wed Jun 22 2022 11:09:50 GMT+0800 (Philippine Standard Time)
</div>
</div>
<script src="../../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../../sorter.js"></script>
</body>
</html>
